<!DOCTYPE html>
<html>

<head>
    <title>{% if admin %}Gest√£o de Stocks - Admin{% else %}Gest√£o de Stocks{% endif %}</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='ico.png') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            flex: 1 0 auto;
            padding: 30px;
            box-sizing: border-box;
        }

        h1,
        h2 {
            text-align: center;
        }

        .intro {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1em;
            color: #333;
        }

        table {
            border-collapse: collapse;
            width: 90%;
            margin: 20px auto;
            background-color: #fff;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: center;
        }

        th {
            background-color: #007BFF;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        form {
            text-align: center;
            margin-top: 30px;
        }

        input[type="password"] {
            padding: 8px;
            width: 200px;
        }

        input[type="submit"] {
            padding: 8px 16px;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
        }

        input[type="submit"]:hover {
            background-color: #0056b3;
        }

        .pagination {
            text-align: center;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            margin: 0 5px;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
        }

        .pagination button:hover {
            background-color: #0056b3;
        }

        .error-message {
            color: red;
            font-weight: bold;
            margin-bottom: 10px;
        }

        #map {
            height: 400px;
            width: 90%;
            margin: 30px auto;
            border: 1px solid #ccc;
        }

        footer {
            background-color: #003366;
            color: white;
            font-size: 0.9em;
            padding: 20px 0;
            text-align: center;
        }

        header {
            background-color: #003366;
            color: white;
            padding: 15px 30px;
            position: relative;
            /* importante para o bot√£o ficar posicionado em rela√ß√£o a este */
            height: 35px;
        }

        .header-title {
            font-size: 1.6em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logout-btn {
            position: absolute;
            top: 12px;
            right: 30px;
            font-size: 1em;
            background-color: #ff4d4d;
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }

        .logout-btn:hover {
            background-color: #cc0000;
        }

        /* ----------- Classes de alerta (s√≥ ser√£o usadas em admin) ----------- */
        tr.stock_vermelho {
            background-color: #ff4d4d !important;
        }

        tr.stock_amarelo {
            background-color: #ffff66 !important;
        }
    </style>
</head>

<body>

    <header>
        <div class="header-title">
            üì¶ <span>Gest√£o de Stocks</span>
        </div>
        {% if admin %}
        <a href="/" class="logout-btn" title="Sair da conta">üîì Logout</a>
        {% endif %}
    </header>

    <div class="container">
        <h1>{% if admin %}P√ÅGINA DE ADMIN{% else %}PRODUTOS EM STOCK{% endif %}</h1>
        <div class="intro">
            {% if admin %}
            Est√°s agora em modo admin! Consegues ver mais informa√ß√µes sobre os produtos.
            {% else %}
            Esta p√°gina mostra os produtos dispon√≠veis no armaz√©m. Use a senha para ver mais detalhes.
            {% endif %}
        </div>

        <table id="stockTable">
            <thead>
                <tr>
                    {% for key in items[0].keys() %}
                    {% if key != 'Alerta' %}
                    <th>{{ key }}</th>
                    {% endif %}
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr {% if admin and item.get('Alerta') %} class="{{ item.get('Alerta') }}" {% endif %}>
                    {% for key, value in item.items() %}
                    {% if key != 'Alerta' %}
                    <td>{{ value }}</td>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="pagination">
            <button onclick="prevPage()">ANTERIOR</button>
            <span id="pageInfo"></span>
            <button onclick="nextPage()">PR√ìXIMO</button>
        </div>

        {% if admin %}
        <div id="map"></div>
        {% endif %}

        {% if not admin %}
        <form method="POST" action="/admin">
            {% if senha_incorreta %}
            <div class="error-message">
                ‚ö†Ô∏è Senha incorreta, tente novamente.
            </div>
            {% endif %}
            <label><strong>PASSWORD:</strong></label>
            <input type="password" name="senha" required>
            <input type="submit" value="LOGIN">
        </form>
        {% endif %}

    </div>

    <footer>
        &copy; 2025 Gest√£o de Stocks | Desenvolvido por Grupo 7 üöÄ<br><br>
        <a href="https://github.com/JoaoPinheiro1311/GestaoDeStocksPython" target="_blank"
            style="color: #66ccff; text-decoration: none; margin: 0 10px;">üêô GitHub</a> |
        <a href="https://docs.google.com/spreadsheets/d/1JDPQrlpZshHa8PWKB_hiXygXC_OwdgXHB2P8z7O_Kz0/edit?gid=0#gid=0"
            target="_blank" style="color: #66ccff; text-decoration: none; margin: 0 10px;">üìä Google Sheets</a>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const rowsPerPage = 10;
        let currentPage = 1;
        const table = document.getElementById("stockTable");
        const rows = table.querySelectorAll("tbody tr");
        const pageInfo = document.getElementById("pageInfo");

        function showPage(page) {
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;

            rows.forEach((row, index) => {
                row.style.display = (index >= start && index < end) ? "" : "none";
            });

            pageInfo.textContent = `P√°gina ${page} de ${Math.ceil(rows.length / rowsPerPage)}`;
        }

        function nextPage() {
            if (currentPage < Math.ceil(rows.length / rowsPerPage)) {
                currentPage++;
                showPage(currentPage);
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                showPage(currentPage);
            }
        }

        showPage(currentPage);


        const map = L.map('map').setView([39.5, -8], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18
        }).addTo(map);

        const coordMap = {};

        rows.forEach((row, index) => {
            const cells = row.querySelectorAll("td");
            if (cells.length < 2) return;

            const latText = cells[cells.length - 2].textContent.trim();
            const lngText = cells[cells.length - 1].textContent.trim();
            const lat = parseFloat(latText.replace(",", "."));
            const lng = parseFloat(lngText.replace(",", "."));

            if (!isNaN(lat) && !isNaN(lng)) {
                const key = lat + "," + lng;
                if (!coordMap[key]) {
                    coordMap[key] = [];
                }
                coordMap[key].push(index + 1);
            }
        });

        const markers = [];
        Object.keys(coordMap).forEach(key => {
            const [latStr, lngStr] = key.split(",");
            const lat = parseFloat(latStr);
            const lng = parseFloat(lngStr);

            const marker = L.marker([lat, lng]).addTo(map);
            const itemNumbers = coordMap[key].join(", ");
            marker.bindPopup(`<strong>Item(s) neste ponto:</strong><br>${itemNumbers}`);
            markers.push(marker);
        });

        if (markers.length > 0) {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds());
        }
    </script>

</body>

</html>