<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>
        {% if admin_full %}
        Gest√£o de Stocks ‚Äì Super Admin
        {% elif admin_basic %}
        Gest√£o de Stocks ‚Äì Admin
        {% else %}
        Gest√£o de Stocks
        {% endif %}
    </title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='ico.png') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: #003366;
            color: white;
            padding: 12px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        .header-search {
            margin-left: 20px;
        }

        .header-search input {
            padding: 6px;
            width: 200px;
            border: none;
            border-radius: 4px;
        }

        .logout-btn {
            background-color: #ff4d4d;
            color: white;
            padding: 6px 12px;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
            transition: background-color 0.2s ease;
            margin-left: 20px;
        }

        .logout-btn:hover {
            background-color: #cc0000;
        }

        .login-form {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .login-form input[type="password"] {
            padding: 6px;
            border: none;
            border-radius: 4px;
            width: 150px;
        }

        .login-form input[type="submit"] {
            padding: 6px 12px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .login-form input[type="submit"]:hover {
            background-color: #0056b3;
        }

        .container {
            flex: 1 0 auto;
            padding: 20px 30px;
            box-sizing: border-box;
        }

        h1,
        h2 {
            text-align: center;
        }

        .intro {
            text-align: center;
            margin-bottom: 16px;
            font-size: 1.1em;
            color: #333;
        }

        .search-bar {
            text-align: center;
            margin: 20px 0;
        }

        .search-bar input {
            padding: 8px;
            width: 300px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        table {
            border-collapse: collapse;
            width: 90%;
            margin: 20px auto;
            background-color: #fff;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: center;
        }

        th {
            background-color: #007BFF;
            color: white;
        }

        th.sortable {
            cursor: pointer;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #eef;
        }

        /* Estilo para o bot√£o de ordena√ß√£o */
        .sort-button {
            background: none;
            border: none;
            color: inherit;
            font: inherit;
            cursor: pointer;
            padding: 0;
        }

        .pagination {
            text-align: center;
            margin-top: 16px;
        }

        .pagination button {
            padding: 8px 12px;
            margin: 0 5px;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination button:hover {
            background-color: #0056b3;
        }

        .error-message {
            color: red;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        #map {
            height: 380px;
            width: 90%;
            margin: 20px auto;
            border: 1px solid #ccc;
        }

        footer {
            background-color: #003366;
            color: white;
            font-size: 0.9em;
            padding: 16px 0;
            text-align: center;
        }

        footer a {
            color: #66ccff;
            text-decoration: none;
            margin: 0 8px;
        }

        /* Classes de alerta (usadas em admin_basic/ admin_full) */
        tr.stock_vermelho {
            background-color: #ff4d4d !important;
        }

        tr.stock_amarelo {
            background-color: #ffff66 !important;
        }

        tr.stock_baixo {
            background-color: #ffffcc !important;
        }
    </style>
</head>

<body>

    <header>
        <div class="header-left">
            <div class="header-title">üì¶ Gest√£o de Stocks</div>

            <!-- BUSCA para todos, inclusive p√∫blico -->
            <div class="header-search">
                <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="üîç Procurar...">
            </div>
        </div>

        {% if not admin_basic and not admin_full %}
        <form method="POST" action="/" class="login-form">
            {% if senha_incorreta %}
            <div class="error-message">‚ö†Ô∏è Senha incorreta, tenta de novo.</div>
            {% endif %}
            <input type="password" name="senha" placeholder="üîí Password..." required>
            <input type="submit" value="Entrar">
        </form>
        {% else %}
        <a href="/" class="logout-btn" title="Sair">üîì Logout</a>
        {% endif %}
    </header>

    <div class="container">
        <h1>
            {% if admin_full %}
            PAINEL SUPER ADMIN
            {% elif admin_basic %}
            PAINEL ADMIN
            {% else %}
            PRODUTOS EM STOCK
            {% endif %}
        </h1>

        <div class="intro">
            {% if admin_full %}
            Acedeste com privil√©gios de Super Administrador. Tens acesso completo a todas as funcionalidades e
            informa√ß√µes detalhadas ‚Äî incluindo dados restritos que nem mesmo os administradores b√°sicos conseguem
            visualizar.
            {% elif admin_basic %}
            Acedeste com permiss√µes de Administrador. Podes ver informa√ß√µes adicionais e detalhes que n√£o est√£o
            dispon√≠veis ao p√∫blico geral.
            {% else %}
            Est√°s a visualizar a vers√£o p√∫blica da p√°gina. Para aceder a mais funcionalidades e dados detalhados,
            efetua login com uma conta de administrador.
            {% endif %}
        </div>

        <!-- Tabela de Stock -->
        <table id="stockTable">
            <thead>
                <tr>
                    {% set col_idx = 0 %}
                    {% for key in items[0].keys() %}
                    {% if key != 'Alerta' %}
                    {# Sempre mostra o bot√£o de sort, independentemente do admin #}
                    {% if admin_full %}
                    <th class="sortable" data-col="{{ col_idx }}">
                        <button class="sort-button">{{ key }} üîΩ</button>
                    </th>
                    {% set col_idx = col_idx + 1 %}
                    {% elif admin_basic and key not in ['Quantidade em Stock','Latitude','Longitude'] %}
                    <th class="sortable" data-col="{{ col_idx }}">
                        <button class="sort-button">{{ key }} üîΩ</button>
                    </th>
                    {% set col_idx = col_idx + 1 %}
                    {% elif not admin_basic and not admin_full and key not in ['Quantidade em
                    Stock','Latitude','Longitude'] %}
                    <th class="sortable" data-col="{{ col_idx }}">
                        <button class="sort-button">{{ key }} üîΩ</button>
                    </th>
                    {% set col_idx = col_idx + 1 %}
                    {% endif %}
                    {% endif %}
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr {% if (admin_basic or admin_full) and item['Alerta'] %} class="{{ item['Alerta'] }}" {% endif %}>
                    {% for key, value in item.items() %}
                    {% if key != 'Alerta' %}
                    {% if admin_full %}
                    <td>{{ value }}</td>
                    {% elif admin_basic and key not in ['Quantidade em Stock','Latitude','Longitude'] %}
                    <td>{{ value }}</td>
                    {% elif not admin_basic and not admin_full and key not in ['Quantidade em
                    Stock','Latitude','Longitude'] %}
                    <td>{{ value }}</td>
                    {% endif %}
                    {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- PAGINA√á√ÉO para todos, inclusive p√∫blico -->
        <div class="pagination">
            <button onclick="prevPage()">ANTERIOR</button>
            <span id="pageInfo"></span>
            <button onclick="nextPage()">PR√ìXIMO</button>
        </div>

        {% if admin_full %}
        <!-- Mapa apenas para super-admin -->
        <div id="map"></div>
        {% endif %}
    </div>

    <footer>
        &copy; 2025 Gest√£o de Stocks - Desenvolvido por Grupo 7 üöÄ<br><br>
        <a href="https://github.com/JoaoPinheiro1311/GestaoDeStocksPython" target="_blank">üêô GitHub</a> |
        <a href="https://docs.google.com/spreadsheets/d/1JDPQrlpZshHa8PWKB_hiXygXC_OwdgXHB2P8z7O_Kz0/edit?gid=0#gid=0"
            target="_blank">üìä Google Sheets</a>
    </footer>

    <!-- Leaflet JS (para o mapa) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    {% if admin_full %}
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const allRows = Array.from(document.querySelectorAll("#stockTable tbody tr"));
            const mapDiv = document.getElementById("map");
            if (!mapDiv || allRows.length === 0) return;

            const map = L.map("map", {
                center: [39.5, -8],
                zoom: 6,
                zoomControl: false
            });
            L.control.zoom({ position: "topright" }).addTo(map);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 18,
                attribution: "&copy; OpenStreetMap"
            }).addTo(map);

            const coordMap = {};
            allRows.forEach((row, idx) => {
                const cells = row.querySelectorAll("td");
                if (cells.length < 2) return;
                const lat = parseFloat(cells[cells.length - 2].innerText.replace(",", "."));
                const lng = parseFloat(cells[cells.length - 1].innerText.replace(",", "."));
                if (isNaN(lat) || isNaN(lng)) return;
                const key = `${lat.toFixed(4)},${lng.toFixed(4)}`;
                if (!coordMap[key]) coordMap[key] = [];
                coordMap[key].push(idx + 1);
            });

            const markerGroup = L.featureGroup();
            for (const key in coordMap) {
                const [lat, lng] = key.split(",").map(Number);
                const marker = L.marker([lat, lng]).addTo(map);
                marker.bindPopup(`<strong>Item(s) neste ponto:</strong><br>${coordMap[key].join(", ")}`);
                markerGroup.addLayer(marker);
            }

            if (markerGroup.getLayers().length) {
                map.fitBounds(markerGroup.getBounds(), { padding: [20, 20] });
            }
        });
    </script>
    {% endif %}

    <script>
        const rowsPerPage = 10;
        let currentPage = 1;
        const table = document.getElementById("stockTable");
        const allRows = Array.from(table.querySelectorAll("tbody tr"));
        let filteredRows = [...allRows];
        const pageInfo = document.getElementById("pageInfo");

        function showPage(page) {
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            allRows.forEach(r => r.style.display = "none");
            filteredRows.slice(start, end).forEach(r => r.style.display = "");
            const total = Math.ceil(filteredRows.length / rowsPerPage) || 1;
            pageInfo.textContent = `P√°gina ${page} de ${total}`;
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                showPage(currentPage);
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                showPage(currentPage);
            }
        }

        function filterTable() {
            const filtro = document.getElementById("searchInput").value.toLowerCase();
            filteredRows = allRows.filter(row => {
                const texto = row.textContent.toLowerCase();
                return texto.includes(filtro);
            });
            currentPage = 1;
            showPage(currentPage);
        }

        let currentSortCol = -1;
        let ascending = true;
        function sortTable(colIndex) {
            filteredRows.sort((a, b) => {
                let x = a.cells[colIndex].innerText.trim();
                let y = b.cells[colIndex].innerText.trim();
                const xNum = parseFloat(x.replace(',', '.'));
                const yNum = parseFloat(y.replace(',', '.'));
                if (!isNaN(xNum) && !isNaN(yNum)) {
                    x = xNum;
                    y = yNum;
                }
                if (x < y) return ascending ? -1 : 1;
                if (x > y) return ascending ? 1 : -1;
                return 0;
            });
            const tbody = table.tBodies[0];
            filteredRows.forEach(r => tbody.appendChild(r));
            ascending = (currentSortCol === colIndex) ? !ascending : true;
            currentSortCol = colIndex;
            currentPage = 1;
            showPage(currentPage);
        }

        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll("#stockTable th.sortable .sort-button").forEach(btn => {
                btn.addEventListener("click", () => {
                    const th = btn.closest("th");
                    const col = parseInt(th.getAttribute("data-col"));
                    sortTable(col);
                });
            });
            showPage(currentPage);
        });
    </script>

</body>

</html>